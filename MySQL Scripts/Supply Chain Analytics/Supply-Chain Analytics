/* ============================================================
   1) Forecast Accuracy Report for All Customers
   ============================================================

   As a Product Owner, I need an aggregate forecast accuracy report
   for all customers for a given fiscal year to track forecast
   performance.

   Output Fields:
   - Customer Code
   - Customer Name
   - Market
   - Total Sold Quantity
   - Total Forecast Quantity
   - Net Error (Forecast - Actual)
   - Absolute Error
   - Forecast Accuracy %

   Requirements:
   - Aggregate data at customer level.
   - Parameterized by fiscal year.
   - Reusable for future reporting.
   ============================================================ */

-- Checking row counts in both tables   
select count(*) from fact_sales_monthly; -- 1425706
select count(*) from fact_forecast_monthly; -- 1885941

-- Creating helper table combining actual sales and forecast quantities

DROP TABLE IF EXISTS gdb0041.fact_act_est;

CREATE TABLE gdb0041.fact_act_est AS
SELECT 
    s.date AS date,
    s.fiscal_year AS fiscal_year,
    s.product_code AS product_code,
    s.customer_code AS customer_code,
    s.sold_quantity AS sold_quantity,
    f.forecast_quantity AS forecast_quantity
FROM gdb0041.fact_sales_monthly s
LEFT JOIN gdb0041.fact_forecast_monthly f
    USING (customer_code, product_code, fiscal_year)

UNION

SELECT 
    f.date AS date,
    f.fiscal_year AS fiscal_year,
    f.product_code AS product_code,
    f.customer_code AS customer_code,
    s.sold_quantity AS sold_quantity,
    f.forecast_quantity AS forecast_quantity
FROM gdb0041.fact_forecast_monthly f
LEFT JOIN gdb0041.fact_sales_monthly s
    USING (customer_code, product_code, fiscal_year);


-- Creating temporary table to calculate forecast error metrics for FY 2021

DROP TEMPORARY TABLE IF EXISTS forecast_err_table;

CREATE TEMPORARY TABLE forecast_err_table AS
SELECT
    s.customer_code AS customer_code,
    c.customer AS customer_name,
    c.market AS market,
    SUM(s.sold_quantity) AS total_sold_qty,
    SUM(s.forecast_quantity) AS total_forecast_qty,
    SUM(s.forecast_quantity - s.sold_quantity) AS net_error,
    ROUND(
        SUM(s.forecast_quantity - s.sold_quantity) * 100 
        / SUM(s.forecast_quantity), 1
    ) AS net_error_pct,
    SUM(ABS(s.forecast_quantity - s.sold_quantity)) AS abs_error,
    ROUND(
        SUM(ABS(s.forecast_quantity - s.sold_quantity)) * 100 
        / SUM(s.forecast_quantity), 2
    ) AS abs_error_pct
FROM gdb0041.fact_act_est s
JOIN gdb0041.dim_customer c
    ON s.customer_code = c.customer_code
WHERE s.fiscal_year = 2021
GROUP BY s.customer_code;

-- Final forecast accuracy report sorted by highest accuracy

SELECT 
    *,
    IF(abs_error_pct > 100, 0, 100.0 - abs_error_pct) AS forecast_accuracy
FROM forecast_err_table
ORDER BY forecast_accuracy DESC;

/*
In SQL Server, temporary tables are always created and stored in the dedicated tempdb system database. 
You cannot specify a different schema (e.g., CREATE TABLE HumanResources.#MyTempTable would be invalid); 
they automatically belong to a session-specific, internal schema .
*/
